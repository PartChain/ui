<!--
  ~ Copyright 2021 The PartChain Authors. All Rights Reserved.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!--DASHBOARD-->
<app-introduction-wizard
  *ngIf="this.showIntroduction; else dashboard"
  [fromDashboard]="true"
  [class]="this.showIntroduction ? 'wizard' : ''"
>
</app-introduction-wizard>

<ng-template #dashboard>
  <div class="kpis-container">
    <app-header [title]="this.title"></app-header>
    <!--Kpi stats-->
    <div class="kpis-stats-content">
      <div class="flex flex-row space-x-2">
        <div class="kpis-stats-total-content">
          <div class="flex">
            <section class="pt-2">
              <svg-icon key="car" size="md" class="text-primary"></svg-icon>
            </section>
            <section class="kpis-stats-total-info">
              <p class="component-text p-2">Total of my parts</p>
              <ng-container *ngIf="this.kpis$ | async as kpis; else totalLoading">
                <h4 class="pt-1 px-2">{{ kpis.ownAssetsCount }}</h4>
              </ng-container>
            </section>
          </div>
        </div>
        <div class="kpis-stats-total-content">
          <div class="flex">
            <section class="pt-2">
              <svg-icon key="car-components-2" size="md" class="text-primary"></svg-icon>
            </section>
            <section class="kpis-stats-total-info">
              <p class="component-text p-2">Total of supplied parts</p>
              <ng-container *ngIf="this.kpis$ | async as kpis; else totalLoading">
                <h4 class="pt-1 px-2">{{ kpis.otherAssetsCount }}</h4>
              </ng-container>
            </section>
          </div>
        </div>
      </div>
      <!--Kpi filter form-->
      <div class="flex">
        <div class="kpis-filter-content">
          <form [formGroup]="this.filterForm" (keydown.enter)="this.filter()">
            <mat-form-field class="mr-6">
              <input
                matInput
                [matDatepicker]="productionDateFrom"
                placeholder="Start of period"
                formControlName="productionDateFrom"
                [max]="this.today"
              />
              <mat-datepicker-toggle matSuffix [for]="productionDateFrom"> </mat-datepicker-toggle>
              <mat-datepicker #productionDateFrom> </mat-datepicker>
            </mat-form-field>
            <mat-form-field>
              <input
                matInput
                [matDatepicker]="productionDateTo"
                placeholder="End of period"
                formControlName="productionDateTo"
              />
              <mat-datepicker-toggle matSuffix [for]="productionDateTo"> </mat-datepicker-toggle>
              <mat-datepicker #productionDateTo> </mat-datepicker>
            </mat-form-field>
          </form>
          <section class="kpis-filter-btn">
            <app-button class="w-20" [type]="'submit'" [button]="'primary'" (clickEvent)="this.filter()"
              >Filter
            </app-button>
          </section>
        </div>
      </div>
    </div>
    <!--Kpi number of parts per country-->
    <div class="kpis-charts-grid">
      <div class="kpis-charts-content">
        <section class="bg-white p-4">
          <h3 class="mb-4">Number of parts per country</h3>
          <ng-container *ngIf="this.assetsPerCountry$ | async as assetsPerCountry; else mapLoading">
            <app-map [mapData]="assetsPerCountry"></app-map>
          </ng-container>
        </section>
      </div>
      <!--Kpi transactions list-->
      <div class="kpis-events-content">
        <section class="bg-white p-4">
          <h3 class="mb-4">Events</h3>
          <div *ngIf="this.transactions$ | async as transactions; else skeleton">
            <ng-container *ngIf="this.transactionsList.length > 0; else empty">
              <div class="kpis-events-item" *ngFor="let item of this.transactionsList">
                <section class="kpis-events-status">
                  <svg height="13" width="13">
                    <circle
                      cx="4.5"
                      cy="4.5"
                      r="4.5"
                      [ngClass]="{
                        'ok-item': item.propertyOldValue === 'OK',
                        'nok-item': item.propertyOldValue === 'NOK',
                        'flag-item': item.propertyOldValue === 'FLAG'
                      }"
                    />
                  </svg>
                  <p>
                    <strong>{{ item.propertyOldValue }}</strong>
                  </p>
                  <svg-icon key="arrow-right-line" class="text-dark update-icon pl-1 pr-2"></svg-icon>
                  <svg height="13" width="13">
                    <circle
                      cx="4.5"
                      cy="4.5"
                      r="4.5"
                      [ngClass]="{
                        'ok-item': item.propertyNewValue === 'OK',
                        'nok-item': item.propertyNewValue === 'NOK',
                        'flag-item': item.propertyNewValue === 'FLAG'
                      }"
                    />
                  </svg>
                  <p>
                    <strong>{{ item.propertyNewValue }}</strong>
                  </p>
                </section>
                <section class="kpis-events-status-total">
                  <p class="sub-headline text-center w-full">
                    {{ this.messageToDisplay(item.totalOfTransactions) }}
                  </p>
                </section>
                <section class="kpis-events-status-date">
                  <p class="sub-headline text-center text-tundoraShadeNobel w-full">
                    {{ item.timestampCreated | date: 'dd-MM-yyyy HH:mm' }}
                  </p>
                </section>
              </div>
            </ng-container>
          </div>
        </section>
      </div>
      <!--Kpi total of nok parts-->
      <div class="kpis-nok-chart-content">
        <div class="lg:mr-4">
          <section class="bg-white p-4">
            <h3 class="mb-4">Total of NOK parts</h3>
            <div *ngIf="this.kpis$ | async as kpis; else chartLoading">
              <ng-container *ngIf="this.checkForNOKChartValues(kpis.qualityStatusRatio) > 0; else emptyNOKGraph">
                <app-bar-chart [barChartData]="kpis.qualityStatusRatio"></app-bar-chart>
              </ng-container>
            </div>
          </section>
        </div>
        <!--Kpi number of parts per day-->
        <div>
          <section class="kpis-assets-per-day-content">
            <h3 class="mb-4">Number of parts per day</h3>
            <div *ngIf="this.assetsPerDay$ | async as assetsPerDay; else chartLoading">
              <ng-container *ngIf="!this.isKpisEmpty(assetsPerDay); else emptyAssetsPerDay">
                <app-line-chart [lineChartData]="assetsPerDay"></app-line-chart>
              </ng-container>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</ng-template>
<!--Kpi empty states-->
<ng-template #empty>
  <section class="kpis-empty-state">
    <svg-icon key="information-line" size="xs" class="text-primary"></svg-icon>
    <p class="regular-text mx-2">Your transaction cart is empty.</p>
  </section>
</ng-template>

<ng-template #emptyAssetsPerDay>
  <section class="kpis-empty-state-charts">
    <svg-icon class="text-primary" key="line-chart-fill" size="xl"></svg-icon>
    <p class="large-text mt-10">No available data on the selected period.</p>
    <p class="large-text">Please adjust your filter.</p>
  </section>
</ng-template>

<ng-template #emptyNOKGraph>
  <section class="kpis-empty-state-charts">
    <svg-icon class="text-primary" key="bar-chart-2-fill" size="xl"></svg-icon>
    <p class="large-text mt-10">No available data on the selected period.</p>
    <p class="large-text">Please adjust your filter.</p>
  </section>
</ng-template>
<!--Kpi loading states-->
<ng-template #skeleton>
  <div class="kpis-empty-state">
    <p class="skeleton"></p>
  </div>
</ng-template>

<ng-template #mapLoading>
  <div class="map-skeleton"></div>
</ng-template>

<ng-template #chartLoading>
  <div class="chart-skeleton"></div>
</ng-template>

<ng-template #totalLoading>
  <p class="skeleton"></p>
</ng-template>
